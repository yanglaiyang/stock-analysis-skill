# 数据优先级系统更新总结

## ✅ 已完成的更新

### 1. 系统提示词更新

**文件**: `src/stock_analyzer.py`

**更新内容**:
- 明确定义了三级数据源优先级
- 要求AI严格按照优先级使用数据
- 要求每个数据引用都必须标注来源

```python
🥇 第一优先级：用户上传的PDF文件（券商研报、财报等）
🥈 第二优先级：Tushare MCP 实时数据
🥉 第三优先级：AI内部知识库
```

---

### 2. 用户提示词优化

**功能**:
- 根据是否上传PDF，动态生成优先级说明
- 清晰标注当前分析的数据源
- 明确告知AI哪个数据应该优先使用

**示例1：无PDF时**
```
📊 数据源优先级说明：
🥇 第一优先级：Tushare MCP 实时数据 - 这是本次分析的主要数据源
🥈 第二优先级：AI内部知识库 - 仅作为补充

重要: 本次分析中，你必须优先使用Tushare MCP提供的实时数据！
```

**示例2：有PDF时**
```
📊 数据源优先级说明：
🥇 第一优先级：用户上传的PDF文件（1个文件）- 这是本次分析的主要数据源
🥈 第二优先级：Tushare MCP 实时数据 - 用于验证和补充PDF数据
🥉 第三优先级：AI内部知识库 - 仅作为补充

重要: 本次分析中，你必须优先使用上传的PDF文件中的数据和分析观点！
```

---

### 3. 数据引用规范

**要求AI在报告中明确标注数据来源**:

| 数据源 | 引用格式 | 示例 |
|--------|----------|------|
| PDF文件 | "根据上传的XX研报..." | "根据上传的券商研报，营业收入为..." |
| Tushare | "根据Tushare数据..." | "根据Tushare数据（截至20250930）..." |
| AI知识库 | "根据AI内部知识库..." | "根据AI内部知识库（白酒行业通用知识）..." |

---

## 📊 测试结果

### 测试案例：平安银行（无PDF）

**命令**:
```bash
python3 src/stock_analyzer.py -c "平安银行, 000001.SZ"
```

**结果**:
- ✅ 报告明确标注："核心数据来源: 平安银行 Q3 2025 利润表, Tushare MCP 实时数据"
- ✅ 使用Tushare数据：营业利润460.97亿
- ✅ 缺失数据时使用AI知识库并标注："根据AI内部知识库..."
- ✅ 所有数据引用都有明确来源标注

---

## 🎯 使用方式

### 方式1：仅使用Tushare数据（推荐日常使用）

```bash
/stock-analysis-skill "洋河股份, 002304.SZ" -o report.md
```

**特点**:
- 使用Tushare实时数据
- 数据权威可靠
- 快速获取分析报告

---

### 方式2：PDF + Tushare（推荐专业分析）

```bash
/stock-analysis-skill "洋河股份, 002304.SZ" \
  -f 券商研报.pdf \
  -o report.md
```

**特点**:
- 🥇 优先使用PDF中的专业分析
- 🥈 Tushare数据验证和补充
- 最全面的专业分析

---

### 方式3：PDF + 参考链接 + Tushare

```bash
/stock-analysis-skill "洋河股份, 002304.SZ" \
  -f 研报.pdf \
  -l "https://example.com/report.pdf" \
  -o report.md
```

**特点**:
- 🥇 PDF专业分析
- 🥈 Tushare实时数据
- 🥉 参考链接补充
- 最完整的分析方案

---

## 📋 数据冲突处理规则

### 规则1：PDF vs Tushare

**处理方式**: 优先使用PDF数据

**原因**:
- PDF通常包含更详细的调整后数据
- 券商研报有专业分析观点
- 可能包含预测和前瞻性信息

**报告示例**:
> "根据上传的券商研报，洋河股份2025年营收预测为200亿元（Tushare实际数据为180.90亿元，差异源于研报的预测性）"

---

### 规则2：Tushare vs AI知识库

**处理方式**: 优先使用Tushare数据

**原因**:
- Tushare是官方权威数据源
- AI知识库可能已过时
- Tushare数据实时更新

---

## 📝 报告质量提升

### 更新前的问题

❌ 数据来源不明确
❌ 不知道用了哪些数据
❌ 可信度难以判断
❌ 无法追溯数据来源

### 更新后的优势

✅ 明确标注数据来源
✅ 清晰的优先级说明
✅ 每个数据都可追溯
✅ 提高报告可信度
✅ 专业的引用格式

---

## 🎨 界面提示优化

### 控制台输出

```bash
✅ Tushare MCP 客户端初始化成功
✅ AI财务分析师已初始化（使用 Gemini AI + Tushare MCP），准备就绪。
   正在从 Tushare MCP 获取 002304.SZ 的数据...
✅ Tushare MCP 数据获取完成。

🚀 AI正在撰写报告，请稍候...
✅ 报告已保存至: report.md
```

---

## 📈 数据可信度对比

| 数据源 | 可信度 | 时效性 | 专业性 | 推荐度 |
|--------|--------|--------|--------|--------|
| 券商研报PDF | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 🔥 最推荐 |
| Tushare数据 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ 推荐 |
| AI知识库 | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⚠️ 补充 |

---

## 🚀 未来优化方向

### 可能的改进

1. **PDF内容提取增强**
   - 支持扫描版PDF（OCR）
   - 支持更多格式（Word、Excel）
   - 智能提取表格数据

2. **Tushare数据扩展**
   - 添加更多财务指标
   - 支持历史数据对比
   - 行业对比数据

3. **数据验证机制**
   - 自动检测数据异常
   - PDF与Tushare数据对比
   - 缺失数据提醒

---

## ✅ 总结

数据优先级系统已成功实现并测试通过！

**核心特点**:
1. ✅ PDF文件为最高优先级
2. ✅ Tushare数据为第二优先级
3. ✅ AI知识库作为补充
4. ✅ 所有数据都标注来源
5. ✅ 清晰的冲突处理规则

**使用建议**:
- 🎯 **专业分析**: 上传券商研报PDF
- 🎯 **快速分析**: 直接使用Tushare数据
- 🎯 **完整分析**: PDF + Tushare + 参考链接

---

**更新日期**: 2025-02-02
**版本**: v2.1.0
**状态**: ✅ 已完成并测试通过
